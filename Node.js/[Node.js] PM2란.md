# PM2란?
- Process Manager의 약자로 NodsJS 프로세서를 관리하는 원활한 서버 운영을 위한 패키지이다.

- 대표적으로 아래와 같은 기능을 제공한다.
<img width="1141" height="298" alt="image" src="https://github.com/user-attachments/assets/9ee56a73-184b-49a3-b477-2c0b900f74ca" />

- 서비스를 제공하고 있는 도중 갑자기 서버가 중지되도 서버를 재실행 해준다.
- Node.js는 싱글 스레드 기반이지만, 멀티 코어 혹은 하이퍼 스레딩을 사용할 수 있게 해준다.
- 클라이언트로부터 요청이 올 때 알아서 요청을 여러 노드 프로세스에 고르게 분배한다. (로드밸런싱)
<br>

- 따라서 하나의 프로세스가 받는 부하가 적어지므로 서비스를 더 원활하게 운영할수 있게 된다.
<br>
<hr>
<br>

## ✔️ 들어가기전... Node.js는 싱글 스레드
- Node.js는 기본적으로 싱글 스레드로 돌아간다.

- 때문에 단일 CPU 코어에서 실행되므로 CPU의 멀티코어 시스템은 사용할 수 없다.

- 그래서 만약 서버의 사양이 8코어 16쓰레드면, 프로그램을 돌리는데 최대 16개 코어를 사용할 수 있지만<br>
노드의 경우 싱글 스레드 이기 때문에 모든 코어를 사용하지 못해 최대 성능을 내지 못하게 된다.

- 즉, 자원을 제대로 사용하지 못한다
<br>
<br>

### 문제 해결
- 위와 같은 문제렬 해결하기 위해 [클러스터 모듈](https://inpa.tistory.com/entry/NODE-%F0%9F%93%9A-cluster-%EB%AA%A8%EB%93%88-%EC%BD%94%EC%96%B4%EB%A5%BC-%EC%B6%94%EA%B0%80%EB%A1%9C-%EC%82%AC%EC%9A%A9?category=890802)을 통해 단일 프로세스를 멀티 프로세스로 늘릴 수 있는 방법을 제공한다.

- 개발자는 클러스터 모듈을 사용해서 마스터 프로세에서 코어 수 만큼 워커 프로세스를 생성해서 모든 코어를 사용하게끔 로직을 짜면, 자원 낭비 없이 서버를 돌릴 수 있다.

- 이것이 서버 프로그래밍의 본좌지만, 서비스를 배포하는데 있어 개발 주기가 늘어나게 된다는 단점이 있다.

- 예를 들어 워커 프로세스가 생성됐을 때 이벤트가 마스터 프로세스로 전달되면 어떻게 처리할지, 워커 프로세스와 마스터 프로세스에 수식 실행 로직을 어떻게 분리해서 구성해야 할지, 워커 프로세스가 메모리 제한선에 도달하거나 예상치 못한 오류로 종료되면서 종료(exit) 이벤트를 전달할 땐 어떻게 처리할지 등등 고민할 게 많다.
<br>
<br>

### 결론
- 따라서 이런 최적화 작업들을 직접 구현하는 것 보다는 솔루션을 사용해 문제를 간편하게 해결하는 것이 옳은 방법이다.

- 다행히 노드 진영에는 PM2라는 Node.js의 프로세스 매니저가 존재한다.
<br>
<hr>
<br>

✔️ 사용 이유
### 일반적인 Nods.js 실행의 문제점
```
# 이렇게 실행하면...
node app.js

# 문제점들:
# 1. 터미널을 닫으면 앱이 종료됨
# 2. 에러 발생 시 앱이 죽으면 수동으로 재시작해야 함
# 3. CPU 사용량이 높아도 대응 불가
# 4. 로그 관리가 어려움
# 5. 여러 인스턴스 실행이 복잡함
```
<br>
<br>

### PM2를 사용하면
```
# 이렇게 실행하면...
pm2 start app.js

# 해결되는 것들:
# ✅ 터미널을 닫아도 앱이 계속 실행됨
# ✅ 에러 발생 시 자동으로 재시작
# ✅ CPU 사용량 모니터링 및 자동 스케일링
# ✅ 로그 자동 관리 및 로테이션
# ✅ 여러 인스턴스 쉽게 관리
```
<br>
<hr>
<br>

## ✔️ 단점
- 멀티 스레딩이 아니므로 서버의 메모리 같은 자원을 공유하지 못한다.
<br>
<br>

### 예시
- 서버 운영 시 가장 많이 사용하는 세션은 메모리에 저장 후 사용되는데, 메모리를 공유하지 못하면 서비스에 큰 지장을 준다.

- 웹 서비스에 로그인 시 사용자의 정보가 세션에 들어가 있는데, 그 후 새로고침을 반복할 때 세션 메모리가 있는 프로세스로 요청이 가면 로그인 상태가 되고<br>
세션 메모리가 없는 프로세스로 요청이 가면 로그인되지 않은 상태가 되기 때문이다.

- 따라서 이 문제를 해결하기 위해서 세션을 공유할 수 있는 무언가가 필요하다.
  - 보통 멤캐시드나 레디스 같은 서비스를 사용
<br>

```
! TIP

하나의 프로세스 내에서 돌아가는 멀티 쓰레드는 메모리를 공유할수 있지만, 멀티 프로세스는 프로세스간의 메모리 공유를 할수가 없다.
```
<br>
<hr>
<br>

**Reference**<br>

[Inpa Dev : PM2 모듈 사용법 - 클러스터 / 무중단 서비스](https://inpa.tistory.com/entry/node-%F0%9F%93%9A-PM2-%EB%AA%A8%EB%93%88-%EC%82%AC%EC%9A%A9%EB%B2%95-%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0-%EB%AC%B4%EC%A4%91%EB%8B%A8-%EC%84%9C%EB%B9%84%EC%8A%A4)<br>
[문앵 : pm2, 왜 쓸까?](https://muna76.tistory.com/259)<br>
