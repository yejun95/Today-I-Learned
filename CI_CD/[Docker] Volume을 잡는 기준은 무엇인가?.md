# Volume을 잡는 기준은 무엇인가?
- 도커를 사용하기 위해서는 Volume이라는 개념을 반드시 알아야한다.
  - Volume에 대한 정보는 아래 게시글 참조
  - [Docker Volume이란](https://github.com/yejun95/Today-I-Learned/blob/master/CI_CD/Docker%5D%20volume%EC%9D%B4%EB%9E%80.md)
<br>

- 그러나 도커를 처음 접하는 사용자라면 어떤 부분을 볼륨으로 잡아야 하는지 감을 잡지 못한다.

- 휘발되도 괜찮은 데이터와 영속해야 되는 데이터를 구분해서 볼륨을 잡아야 최적의 이미지를 통해서 컨테이너를 생성할 수 있게 된다.
<br>
<hr>
<br>

## ✔️ Volume을 잡는 기준
### 휘발되도 괜찮은 데이터
- 애플리케이션 소스 코드 (프로덕션 환경)
  - 이미지 빌드 시 포함되어야 하며, 컨테이너 실행 중 변경되지 않음
  - 코드 변경 시 새로운 이미지를 빌드하여 배포
<br>

- 의존성 패키지 (`node_modules`, `vendor` 등)
  - 이미지 빌드 시 설치되며, 매번 동일한 버전 유지
  - 패키지 변경 시 이미지 재빌드 필요
<br>

- 정적 파일 (CSS, JS, 이미지 등)
  - 배포 시점에 고정되며, 변경 시 새 이미지 배포
  - 사용자가 게시글에 업로드하는 파일을 말하는 것이 아님!!
<br>

- 임시 캐시 데이터
  - 애플리케이션이 시작할 때마다 새로 생성 가능
  - ex) 빌드 캐시, 임시 파일
<br>
<br>

### 영속해야 되는데이터
- 데이터의 영속성이 필요한 경우
  - 데이터베이스 데이터 (`/var/lib/mysql`, `/var/lib/postgresql`)`
  - 사용자 업로드 파일 (이미지, 동영상 등)
  - 로그 파일
  - 설정 파일 (`application.properties`, `application.yml` 등...)
<br>

- 호스트와 컨테이너 간 데이터 공유가 필요한 경우
  - 개발중인 소스 코드 (로컬 개발 환경)
  - 설정 파일 동기화
  - 빌드 아티팩트
<br>

- 컨테이너 재시작 후에도 유지되어야 하는 데이터
  - 애플리케이션 상태
  - 캐시 데이터
  - 세션 정보
<br>
<hr>
<br>

## ✔️ 환경별 Volume 전략
### 로컬 개발 환경
```
volumes:
  - ./src:/app/src              # 소스 코드 (개발 중 실시간 반영)
  - ./data:/app/data            # 데이터베이스 (영속성)
  - ./logs:/app/logs            # 로그 파일 (영속성)
  - ./config:/app/config        # 설정 파일 (수정 용이)
```
<br>

- 특징
  - 소스 코드를 볼륨으로 마운트하여 실시간 개발 가능
  - 핫 리로딩을 통한 빠른 개발 사이클
<br>
<br>

### 프로덕션 개발 환경
```
volumes:
  - app-data:/app/data          # 데이터베이스 (Named Volume)
  - app-logs:/app/logs          # 로그 파일 (Named Volume)
  - app-uploads:/app/uploads    # 업로드 파일 (Named Volume)
  # src는 이미지에 포함, 볼륨 마운트 X
```
<br>

- 특징
  - 소스 코드는 이미지에 포함하여 불변성 보장
  - 영속성이 필요한 데이터만 Named Volume 사용
  - 보안 및 성능 최적화
<br>
<br>

### 판단 기준 체크리스트
| 질문 | Yes → 볼륨 필요 | No → 이미지 포함 |
|------|:---------------:|:----------------:|
| 컨테이너 재시작 시 데이터가 유지되어야 하는가? | ✅ | ❌ |
| 여러 컨테이너가 동일한 데이터를 공유해야 하는가? | ✅ | ❌ |
| 런타임에 데이터가 생성되거나 변경되는가? | ✅ | ❌ |
| 백업이 필요한 데이터인가? | ✅ | ❌ |
| 개발 중 실시간으로 변경 사항을 확인해야 하는가? (로컬 개발) | ✅ | ❌ |
| 배포 시점에 고정되어야 하는가? (프로덕션 코드) | ❌ | ✅ |
| 이미지 빌드 시 포함되어야 하는가? (의존성, 정적 파일) | ❌ | ✅ |
<br>
<hr>
<br>

## ✔️ 실전 예제
### 잘못된 볼륨 설정
```
# 프로덕션 환경에서 소스 코드를 볼륨으로 마운트
volumes:
  - ./src:/app/src  # 위험: 호스트 파일 시스템에 의존
  - ./node_modules:/app/node_modules  # 불필요: 이미지에 포함되어야 함
```
<br>

- 문제점
  - 호스트 파일 시스템에 의존하여 이식성 저하
  - 서버마다 다른 코드가 실행될 위험
  - 보안 취약점 발생 가능
<br>
<br>

### 올바른 볼륨 설정
```
# 프로덕션 환경
volumes:
  - app-data:/app/data          # 데이터베이스 데이터
  - app-uploads:/app/uploads    # 사용자 업로드 파일
  - app-logs:/app/logs          # 로그 파일
```
<br>

- 영속성이 필요한 데이터만 볼륨 사용

- 소스 코드는 `Dockerfile`에서 `COPY` 명령어로 이미지에 포함

- 컨테이너 불변성 보장
<br>
<hr>
<br>

## ✔️ 결론
**올바른 볼륨 전략을 사용하면:**

- 이미지 크기 최적화: 불필요한 데이터를 이미지에 포함하지 않음

- 성능 향상: I/O 오버헤드 최소화

- 보안 강화: 호스트 파일 시스템 노출 최소화

- 유지보수 용이: 데이터와 코드의 명확한 분리
<br>

**핵심 원칙: "변경되지 않는 것은 이미지에, 변경되는 것은 볼륨에"**
